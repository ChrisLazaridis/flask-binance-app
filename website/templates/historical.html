{% extends 'base.html' %}

{% block content %}
  <style>
    #mainChartContainer{
      position: relative;
      margin: auto;
      width: 100%;
      height: 650px;
    }
    #volumeChartContainer{
      position: relative;
      margin: auto;
      width: 100%;
      height: 150px;
    }
  </style>
  <h1>Historical Data for {{ symbol }}</h1>
  <table id="historicalData" hidden>
    <tr>
      <th>Timestamp</th>
      <th>Open Price</th>
      <th>High Price</th>
      <th>Low Price</th>
      <th>Close Price</th>
      <th>Volume</th>
    </tr>
    {% for i in range(timestamps|length) %}
    <tr>
      <td>{{ timestamps[i] }}</td>
      <td>{{ open_prices[i] }}</td>
      <td>{{ high_prices[i] }}</td>
      <td>{{ low_prices[i] }}</td>
      <td>{{ close_prices[i] }}</td>
      <td>{{ volumes[i] }}</td>
    </tr>
    {% endfor %}
  </table>



  <div id="mainChartContainer">
    <canvas id="mainChart"></canvas>
  </div>


  <div id="volumeChartContainer">
    <canvas id="volumeChart"></canvas>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Extract data from the HTML table
      const table = document.getElementById("historicalData");
      if (table) {
        const data = [];
        for (let i = 1; i < table.rows.length; i++) {
          const row = table.rows[i];
          const timestamp = row.cells[0].textContent;
          const open = parseFloat(row.cells[1].textContent);
          const high = parseFloat(row.cells[2].textContent);
          const low = parseFloat(row.cells[3].textContent);
          const close = parseFloat(row.cells[4].textContent);
          const volume = parseFloat(row.cells[5].textContent);

          data.push({
            timestamp: timestamp,
            open: isNaN(open) ? 0 : open,
            high: isNaN(high) ? 0 : high,
            low: isNaN(low) ? 0 : low,
            close: isNaN(close) ? 0 : close,
            volume: isNaN(volume) ? 0 : volume,
          });
        }

        // Calculate fluctuations and other stats
        const timestamps = data.map((item) => item.timestamp);
        const fluctuations = data.map((item) => item.high - item.low);
        const openPrices = data.map((item) => item.open);
        const highPrices = data.map((item) => item.high);
        const lowPrices = data.map((item) => item.low);
        const closePrices = data.map((item) => item.close);
        const volumes = data.map((item) => item.volume);

        // Create the main chart using Chart.js library
        const mainCtx = document.getElementById("mainChart").getContext("2d");
        new Chart(mainCtx, {
          type: "line",
          data: {
            labels: timestamps,
            datasets: [
             {
            label: "Fluctuations",
            data: fluctuations,
            borderColor: "rgba(75, 192, 192, 1)",
            borderWidth: 2,
            fill: false,
          },
          {
            label: "Open Prices",
            data: openPrices,
            borderColor: "rgba(255, 99, 132, 1)",
            borderWidth: 2,
            fill: false,
          },
          {
            label: "High Prices",
            data: highPrices,
            borderColor: "rgba(54, 162, 235, 1)",
            borderWidth: 2,
            fill: false,
          },
          {
            label: "Low Prices",
            data: lowPrices,
            borderColor: "rgba(255, 206, 86, 1)",
            borderWidth: 2,
            fill: false,
          },
          {
            label: "Close Prices",
            data: closePrices,
            borderColor: "rgba(153, 102, 255, 1)",
            borderWidth: 2,
            fill: false,
          }
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              zoom: {
                zoom: {
                  wheel: {
                    enabled: true,
                  },
                  pinch: {
                    enabled: true,
                  },
                  mode: 'xy',
                }
              },
              title: {
                display: true,
                text: "Historical Data",
              },
              x: {
                display: true,
                title: {
                  display: true,
                  text: "Timestamp",
                },
              },
              y: {
                display: true,
                title: {
                  display: true,
                  text: "Values",
                },
              },
            },
          },
        });

        // Create the volume chart using Chart.js library
        const volumeCtx = document.getElementById("volumeChart").getContext("2d");
        new Chart(volumeCtx, {
          type: "bar", // Use a bar chart for volumes
          data: {
            labels: timestamps,
            datasets: [
              {
                label: "Volume",
                data: volumes,
                backgroundColor: "rgba(255, 159, 64, 0.6)",
                borderColor: "rgba(255, 159, 64, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                display: true,
                title: {
                  display: true,
                  text: "Timestamp"
                }
              },
              y: {
                display: true,
                title: {
                  display: true,
                  text: "Volume",
                },
              },
            },
          },
        });
      }
    });
  </script>
{% endblock %}